{% extends "layout.html" %}
{% block title %}Dashboard - Enhanced Inventory Management{% endblock %}

{% block content %}
    <button id="dark-mode-toggle" class="btn btn-secondary">
        <i class="fas fa-moon"></i>
    </button>

    <main id="dashboard" class="active">
        <div class="summary-cards">
            <div class="card">
                <h3>Total Sales</h3>
                <p id="total-sales">RS.0</p>
            </div>
            <div class="card">
                <h3>Total Purchases</h3>
                <p id="total-purchases">RS.0</p>
            </div>
            <div class="card">
                <h3>Current Stock</h3>
                <p id="current-stock">0 items</p>
            </div>
        </div>

        <div class="dashboard-charts">
            <div class="chart">
                <canvas id="sales-chart"></canvas>
            </div>
            <div class="chart">
                <canvas id="purchases-chart"></canvas>
            </div>
            <div class="chart">
                <canvas id="top-selling-chart"></canvas>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetchSummary(); // Fetch data when the page loads
            fetchChartData(); // Fetch chart data when the page loads

            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const dashboard = document.getElementById('dashboard');

            darkModeToggle.addEventListener('click', function() {
                dashboard.classList.toggle('dark-mode');
                darkModeToggle.classList.toggle('active');
                if (dashboard.classList.contains('dark-mode')) {
                    darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                } else {
                    darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                }
            });

            function fetchSummary() {
                fetch('/api/summary')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('total-sales').innerText = `RS.${data.total_sales.toFixed(2)}`;
                        document.getElementById('total-purchases').innerText = `RS.${data.total_purchases.toFixed(2)}`;
                        document.getElementById('current-stock').innerText = `${data.current_stock} items`;
                    })
                    .catch(error => console.error('Error fetching summary data:', error));
            }

            function fetchChartData() {
                fetch('/api/chart-data')
                    .then(response => response.json())
                    .then(data => {
                        const salesCtx = document.getElementById('sales-chart').getContext('2d');
                        const purchasesCtx = document.getElementById('purchases-chart').getContext('2d');
                        const topSellingCtx = document.getElementById('top-selling-chart').getContext('2d');

                        // Sales Chart
                        new Chart(salesCtx, {
                            type: 'bar',
                            data: {
                                labels: data.sales.labels,
                                datasets: [{
                                    label: 'Sales',
                                    data: data.sales.values,
                                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    x: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });

                        // Purchases Chart
                        new Chart(purchasesCtx, {
                            type: 'bar',
                            data: {
                                labels: data.purchases.labels,
                                datasets: [{
                                    label: 'Purchases',
                                    data: data.purchases.values,
                                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                    borderColor: 'rgba(153, 102, 255, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    x: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });

                        // Top Selling Chart
                        new Chart(topSellingCtx, {
                            type: 'pie',
                            data: {
                                labels: data.topSelling.labels,
                                datasets: [{
                                    label: 'Top Selling Products',
                                    data: data.topSelling.values,
                                    backgroundColor: [
                                        'rgba(255, 99, 132, 0.2)',
                                        'rgba(54, 162, 235, 0.2)',
                                        'rgba(255, 206, 86, 0.2)',
                                        'rgba(75, 192, 192, 0.2)',
                                        'rgba(153, 102, 255, 0.2)',
                                        'rgba(255, 159, 64, 0.2)'
                                    ],
                                    borderColor: [
                                        'rgba(255, 99, 132, 1)',
                                        'rgba(54, 162, 235, 1)',
                                        'rgba(255, 206, 86, 1)',
                                        'rgba(75, 192, 192, 1)',
                                        'rgba(153, 102, 255, 1)',
                                        'rgba(255, 159, 64, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true
                            }
                        });
                    })
                    .catch(error => console.error('Error fetching chart data:', error));
            }
        });
    </script>

    <style>
        .dark-mode {
            background-color: #2e2e2e;
            color: #f5f5f5;
        }

        .dark-mode .card {
            background-color: #3c3c3c;
            border: 1px solid #444;
        }

        .dark-mode .btn {
            color: #f5f5f5;
            background-color: #444;
        }

        .btn.active {
            background-color: #666;
        }
    </style>
{% endblock %}
